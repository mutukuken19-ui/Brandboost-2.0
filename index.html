<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandBoost — Firebase Version</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- React + Babel (dev only) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase JS (modular CDN) -->
  <script type="module" id="firebase-init">
    // Import Firebase SDKs from CDN (modular version)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    window.FIREBASE_CONFIG = {
      // TODO: replace with your Firebase config
      apiKey: "YOUR_KEY_HERE",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    window.app = initializeApp(window.FIREBASE_CONFIG);
    window.db = getFirestore(app);
    window.auth = getAuth(app);

    // Export for inline scripts
    window.FirebaseServices = {
      db: window.db,
      auth: window.auth,
      collections: {
        ads: () => collection(window.db, "ads"),
      },
      q: query,
      orderBy,
      onSnapshot,
      addDoc,
      updateDoc,
      doc,
      deleteDoc
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>
  <script type="text/babel">

    // Wait for Firebase scripts to load
    function useFirebase() {
      const [ready, setReady] = React.useState(false);
      React.useEffect(() => {
        const interval = setInterval(() => {
          if (window.FirebaseServices) setReady(true);
        }, 100);
        return () => clearInterval(interval);
      }, []);
      return ready ? window.FirebaseServices : null;
    }

    function App() {
      const firebase = useFirebase();
      const [ads, setAds] = React.useState([]);
      const [user, setUser] = React.useState(null);
      const [modal, setModal] = React.useState(""); // "login", "post", ad for details, etc.
      const [q, setQ] = React.useState("");
      const [cat, setCat] = React.useState("");
      const categories = [ "Services","Food & Drink","Retail","Health", "Education","Automotive","Home","Events" ];

      // Auth state sync
      React.useEffect(() => {
        if (!firebase) return;
        const unsub = firebase.auth.onAuthStateChanged(setUser);
        return () => unsub();
      }, [firebase]);

      // Listen for ads in Firestore
      React.useEffect(() => {
        if (!firebase) return;
        const qAds = firebase.q(firebase.collections.ads(), firebase.orderBy("created", "desc"));
        const unsub = firebase.onSnapshot(qAds, snap => {
          setAds( snap.docs.map(doc => ({id:doc.id, ...doc.data()})) );
        });
        return () => unsub();
      }, [firebase]);

      // CRUD helpers
      const postAd = async (ad) => {
        if (!user) { window.alert("Login first"); return; }
        await firebase.addDoc(firebase.collections.ads(), {
          ...ad,
          created: Date.now(),
          author: user.email,
        });
      };
      const updateAd = async (ad) => {
        await firebase.updateDoc(firebase.doc(window.db, "ads", ad.id), ad);
      };
      const deleteAd = async (adId) => {
        await firebase.deleteDoc(firebase.doc(window.db, "ads", adId));
      };

      // Auth helpers
      const login = async (email, password) => {
        await firebase.auth.signInWithEmailAndPassword(email, password)
        .catch(e => window.alert(e.message));
        setModal("");
      };
      const signup = async (email, password) => {
        await firebase.auth.createUserWithEmailAndPassword(email, password)
        .catch(e => window.alert(e.message));
        setModal("");
      };
      const logout = async () => {
        await firebase.auth.signOut();
        setModal("");
      };

      // Search/filter
      const filteredAds = ads
        .filter(a => !q || (a.title+a.desc).toLowerCase().includes(q.toLowerCase()))
        .filter(a => !cat || a.category === cat);

      if (!firebase) return <div className="p-8 text-lg">Loading Firebase...</div>;
      return (
        <div>
          {/* Header */}
          <header className="bg-white shadow p-4 flex flex-col md:flex-row gap-3 md:items-center sticky top-0 z-10">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-cyan-600 text-white rounded-lg flex items-center justify-center font-bold">BB</div>
              <span className="font-bold text-lg">BrandBoost</span>
            </div>
            <div className="flex flex-1 max-w-lg mx-auto w-full">
              <input
                value={q} onChange={e=>setQ(e.target.value)}
                placeholder="Search businesses..."
                className="flex-1 p-2 border rounded-l outline-none"
              />
              <button className="bg-cyan-600 text-white px-4 rounded-r">Search</button>
            </div>
            <div className="flex gap-2">
              {user && <button onClick={logout} className="border px-3 py-2 rounded">{user.email} (Logout)</button>}
              {!user && <button onClick={()=>setModal("login")} className="bg-cyan-600 text-white px-3 py-2 rounded">Login/Sign Up</button>}
              <button onClick={()=>setModal("post")} className="border px-3 py-2 rounded">Post Ad</button>
            </div>
          </header>
          {/* Categories */}
          <div className="p-4 flex flex-wrap gap-2">
            {categories.map(c=>(
              <button key={c}
                className={`px-3 py-1 border rounded-full ${cat===c?"bg-cyan-600 text-white":"bg-white"}`}
                onClick={()=>setCat(c)}>{c}
              </button>
            ))}
            <button onClick={()=>setCat("")} className="px-3 py-1 border rounded-full">All</button>
          </div>
          {/* Ads Grid */}
          <div className="p-4 grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {filteredAds.map(a=>(
              <div key={a.id} className="bg-white p-3 rounded-xl shadow cursor-pointer"
                  onClick={()=>setModal(a)}>
                {a.img
                  ? <img className="h-32 w-full object-cover rounded mb-2" src={a.img} alt={a.title} />
                  : <div className="h-32 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-500 text-sm">{a.category}</div>
                }
                <div className="font-semibold">{a.title}</div>
                <div className="text-sm text-gray-500">{a.category} • {a.price}</div>
              </div>
            ))}
          </div>
          {/* Modals: render login, signup, post/edit, ad detail */}
          {modal==="login" && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center" onClick={e=>e.target===e.currentTarget&&setModal("")}>
              <div className="bg-white p-6 rounded max-w-sm w-full">
                <h2 className="font-bold text-lg mb-2">Login / Sign Up</h2>
                <AuthForm login={login} signup={signup} close={()=>setModal("")}/>
              </div>
            </div>
          )}
          {modal==="post" && user && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center" onClick={e=>e.target===e.currentTarget&&setModal("")}>
              <div className="bg-white p-6 rounded max-w-sm w-full">
                <h2 className="font-bold text-lg mb-2">Create Ad</h2>
                <AdForm onSubmit={async (form) => {await postAd(form); setModal("");}} onCancel={()=>setModal("")} categories={categories} />
              </div>
            </div>
          )}
          {/* Ad details modal */}
          {modal && typeof modal==="object" && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center" onClick={e=>e.target===e.currentTarget&&setModal("")}>
              <div className="bg-white p-6 rounded max-w-sm w-full">
                <h2 className="font-bold text-xl mb-2">{modal.title}</h2>
                {modal.img && <img className="mb-2 w-full h-48 object-cover rounded" src={modal.img} />}
                <div className="text-gray-500">{modal.category} • {modal.price}</div>
                <div className="mt-2">{modal.desc}</div>
                <div className="mt-3 text-sm text-gray-400">Author: {modal.author || "Unknown"}</div>
                {user && user.email===modal.author && (
                  <div className="flex gap-2 mt-3">
                    <button className="border px-3 py-1 rounded text-xs" onClick={()=>setModal({edit:true, ...modal})}>Edit</button>
                    <button className="border px-3 py-1 rounded text-xs text-red-600" onClick={()=>{deleteAd(modal.id); setModal("")}}>Delete</button>
                  </div>
                )}
                <button className="border px-3 py-2 rounded mt-3" onClick={()=>setModal("")}>Close</button>
              </div>
            </div>
          )}
          {/* Edit form modal */}
          {modal && typeof modal==="object" && modal.edit && (
            <div className="fixed inset-0 bg-black/40 flex items-center justify-center" onClick={e=>e.target===e.currentTarget&&setModal("")}>
              <div className="bg-white p-6 rounded max-w-sm w-full">
                <h2 className="font-bold text-lg mb-2">Edit Ad</h2>
                <AdForm initialData={modal} onSubmit={async (form) => {await updateAd({...modal, ...form}); setModal("");}} onCancel={()=>setModal("")} categories={categories} />
              </div>
            </div>
          )}
        </div>
      );
    }

    // Simple login/signup form
    function AuthForm({login, signup, close}) {
      const [email,setEmail] = React.useState("");
      const [pw,setPw] = React.useState("");
      const [mode,setMode] = React.useState("login");
      return (
        <div>
          <div className="mb-2 flex gap-2">
            <button className={mode==="login"?"bg-cyan-600 text-white px-3 py-1 rounded":"border px-3 py-1 rounded"} onClick={()=>setMode("login")}>Login</button>
            <button className={mode==="signup"?"bg-cyan-600 text-white px-3 py-1 rounded":"border px-3 py-1 rounded"} onClick={()=>setMode("signup")}>Sign Up</button>
          </div>
          <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-2 border rounded mb-2" placeholder="Email" />
          <input type="password" value={pw} onChange={e=>setPw(e.target.value)} className="w-full p-2 border rounded mb-2" placeholder="Password" />
          <button onClick={()=>mode==="login"?login(email,pw):signup(email,pw)} className="bg-cyan-600 text-white px-4 py-2 rounded w-full">{mode==="login"?"Login":"Create Account"}</button>
          <button onClick={close} className="mt-2 px-2 py-1 border rounded text-xs">Close</button>
        </div>
      );
    }

    // Ad create & edit form
    function AdForm({initialData, onSubmit, onCancel, categories}) {
      const blank = { title:"", category:categories[0], price:"", img:"", desc:""};
      const [form, setForm] = React.useState(initialData || blank);
      React.useEffect(()=>{ if(initialData) setForm(initialData); }, [initialData]);
      return (
        <div>
          <input className="w-full p-2 border rounded mb-2" placeholder="Title" value={form.title} onChange={e=>setForm({...form, title:e.target.value})}/>
          <select className="w-full p-2 border rounded mb-2" value={form.category} onChange={e=>setForm({...form, category:e.target.value})}>
            {categories.map(c=><option key={c}>{c}</option>)}
          </select>
          <input className="w-full p-2 border rounded mb-2" placeholder="Price / Details" value={form.price} onChange={e=>setForm({...form, price:e.target.value})}/>
          <input className="w-full p-2 border rounded mb-2" placeholder="Image URL" value={form.img || ""} onChange={e=>setForm({...form, img:e.target.value})}/>
          <textarea className="w-full p-2 border rounded mb-2" placeholder="Description" value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})}/>
          <button className="bg-cyan-600 text-white px-4 py-2 rounded mr-2" onClick={()=>onSubmit(form)}>{form.id ? "Update":"Post"}</button>
          <button className="px-3 py-2 border rounded text-xs" onClick={onCancel}>Cancel</button>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
